#  跨域解决方案推荐



## 背景

跨域问题对于前端来说，是一个老生常谈的问题了，无论是平时工作中，以及面试中基本都会问到。本文将梳理常见的几种跨域的优缺点，以及建议的跨域解决方案。

## 基础

什么是跨域？跨域有哪些解决方案？等等基础知识，请参考这篇文章，讲的比较细致，这里就不在啰嗦。

[https://segmentfault.com/a/1190000011145364](https://segmentfault.com/a/1190000011145364)

## 对比

我们在工作中，用的比较多的三种解决方案：

| 方案      | 优点                                                         | 缺点                                                         | 适用场合                                                     |
| --------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| JSONP     | 1、使用简单；<br/>2、不需要任何配置；                        | 1、GET请求；<br/>2、数据不安全，任何人都可以调用接口；<br/>3、存在[XSS攻击](http://blog.knownsec.com/2015/03/jsonp_security_technic/)； | 1、安全系数要求低；<br/>2、临时使用的接口；<br/>3、应急接口解决方案； |
| CORS      | 1、相对安全，但是如果后台配置 `Access-Control-Allow-Origin` = `*` 就不那么安全了；<br/>2、后台需要配置，如果需要携带Cookie，则前端Ajax也需要配置参数； | 1、需要配置跨域的相关参数，比较麻烦；<br/>2、如果跨域的 `Origin` 配置为 `*` , 不安全 | 1、WEB容器不好配置，跨域只能代码层面处理理；<br/>            |
| Nginx代理 | 1、非常安全，同域请求；<br/>2、前后端代码不需要任何配置      | 1、需要配置WEB容器，对环境要求较高；<br/>2、开发时也需要配置代理才能连调接口 | 1、WEB容器可以自主灵活配置；<br/>2、安全系数要求比较高       |

通过以上对比，我们就比较清楚的了解这3种跨域方式各自的优缺点。对于 `JSONP` 的使用场景，我们很容易确定。但是对于 `CORS` 和 `Nginx代理` 这两种方式，如果在公司里面，我们该如何选择呢？

我个人的建议是，如果是自己的服务器，代码部署都是完全可以自主配置，那么最好使用 `Nginx代理` 的方式。原因就是上面列出来的它的2个优点。

但是如果选择 `Nginx代理` 的方式，就需要配置代理，无论开发还是线上，都需要配置，下面给大家介绍一下个人的经验。 

## Nginx代理

`Nginx代理` 的方法就是通过Nginx做一次中间的转发，使得对于浏览器来说，就不存在跨域的问题，而对于代码部署来说，还是前后端各自部署在自己的容器。

如果采用这种方式，那在开发和测试阶段，分别怎么做呢？

### 本地开发连调

#### 本地 + MockServer

前端代码不需任何配置，只需要MockServer配置 `CORS` 支持跨域请求就可以。

#### 本地 + 他人机器Server

本地需要安装代理软件，如：`Charles`

假设，上线后真实的访问路径和接口为：

* 前端页面地址：http://abcd.vivo.com.cn
* 后台接口地址：http://abcd.vivo.com.cn/api

> 因为通过Nginx代理的方式，要保证域名要相同，所以，只能通过路径来区分前后端的路由。

假设，本地和他人机器Server真实的服务地址为：

* 前端页面服务：http://localhost:8080  (本地的Node服务)
* 后台接口地址：http://172.25.122.86:8888 （他人的Tomcat后台服务）

这时候需要配置 `Charles` 路由 `Map Remote`规则：

![Imgur](https://i.imgur.com/03AKDo4.png)

> 注意：后台接口的路由规则一定要放在前面，即：/api/* 的路由放在页面。

配置好上面的代理后，地址栏直接访问：[http://abcd.vivo.com.cn](http://abcd.vivo.com.cn) 即可。

### 生产环境Nginx配置

我们在本地是通过代理软件转发，而测试或者生产环境，则直接通过Nginx的规则，就可以将上述的路由规则做转发，达到同样的目的。

配置 `nginx.conf` 文件：

```xml
server {
    listen  80;
    server_name abcd.vivo.com.cn;
    
    location / {
        proxy_pass  http://172.25.122.85:3000;
    }
    
    location ~ /api/ {
        proxy_pass  http://172.25.122.86:8080;
    }
}
```

上述配置可以理解为：

* 监听80端口，将 `http://abcd.vivo.com.cn` 的所有请求服务转发到 `172.25.122.85:3000`； 
* 将 `http://abcd.vivo.com.cn/api/` 或者 `http://abcd.vivo.com.cn/api/list` 等请求转发到`http://172.25.122.86:8081`

## 总结

本文重点介绍了通过 `Nginx代理` 的方式，解决跨域的问题，在本地如何工作，发布时线上环境如何部署。如果你有更好的方式，或者觉得本文哪里有问题，欢迎批评指正。

（全文完）